# Reusable template for ClickOnce environment publish (Dev/Prod)
# I'm assuming that you only run this in the main branch after a successful build
# Versioning:
# Add this to your .csproj file:
# <!-- The pipeline will increment and override this, matching the version to the BuildId.
#      Change the pipeline parameter Major and Minor versions as needed
# -->
# <ApplicationVersion>0.0.0.0</ApplicationVersion>
# <!-- MinimumRequiredVersion: Forces ClickOnce clients below this version to auto-update before running. Update with caution. -->
# <MinimumRequiredVersion>1.0.0.0</MinimumRequiredVersion>

parameters:
  - name: environmentName
    type: string
    default: Development
    values:
      - Development
      - Production
  - name: deployRootPath
    type: string
  - name: environmentFolder
    type: string
    default: Dev
    values:
      - Dev
      - Prod
  - name: rootFolder
    type: string
  - name: projectName
    type: string
  - name: artifactName
    type: string
  - name: clickOncePublishUrl
    type: string
  - name: buildConfiguration
    type: string
    default: Release
  - name: selfContained
    type: string
    default: "false"
    values:
      - "true"
      - "false"
  - name: isMain
    type: string
    default: "true"
    values:
      - "true"
      - "false"
  - name: removeAppSettings
    type: object
    default: []
  - name: majorVersion
    type: number
    default: 1
  - name: minorVersion
    type: number
    default: 0

steps:
  # Configure App.config BEFORE publish so it's included in the output
  - task: PowerShell@2
    condition: succeeded()
    displayName: "Configure App.config for ${{ parameters.environmentName }}"
    inputs:
      targetType: inline
      script: |
        $appConfigPath = "${{ parameters.rootFolder }}\\${{ parameters.projectName }}\\App.config"
        if (!(Test-Path $appConfigPath)) {
          Write-Error "App.config missing at $appConfigPath"
          exit 1
        }
        Write-Host "Setting environment token to ${{ parameters.environmentName }}"
        (Get-Content $appConfigPath -Raw) -replace '__ENVIRONMENT__', '${{ parameters.environmentName }}' | Set-Content $appConfigPath

  - task: PowerShell@2
    condition: succeeded()
    displayName: "Build dotnet publish arguments"
    inputs:
      targetType: inline
      script: |
        $args = "$(Build.SourcesDirectory)\\${{ parameters.rootFolder }}\\${{ parameters.projectName }}\\${{ parameters.projectName }}.csproj /p:ApplicationVersion=${{ parameters.majorVersion }}.${{ parameters.minorVersion }}.$(Build.BuildId).0 --configuration ${{ parameters.buildConfiguration }} --output ${{ parameters.deployRootPath }}\${{ parameters.environmentFolder }} /p:PublishUrl=${{ parameters.clickOncePublishUrl }}"
        if ("${{ parameters.selfContained }}" -eq "true") {
          $args += " --self-contained -r win-x64"
        }
        Write-Host "##vso[task.setvariable variable=PublishArgs]$args"

  - task: DotNetCoreCLI@2
    condition: succeeded()
    displayName: "Publish ${{ parameters.environmentName }}"
    inputs:
      command: publish
      publishWebProjects: false
      publishTestResults: false
      arguments: $(PublishArgs)
      zipAfterPublish: false
      modifyOutputPath: false

  - task: PowerShell@2
    condition: succeeded()
    displayName: "Generate publish.htm for ${{ parameters.environmentName }}"
    inputs:
      targetType: inline
      script: |
        $version = "${{ parameters.majorVersion }}.${{ parameters.minorVersion }}.$(Build.BuildId).0"
        $basePath = "${{ parameters.deployRootPath }}\${{ parameters.environmentFolder }}"
        $sourcePublishHtm = "$basePath/publish.htm"
        if (!(Test-Path $sourcePublishHtm)) {
          Write-Error "Base publish.htm not found at $sourcePublishHtm"
          exit 1
        }
        $raw = Get-Content $sourcePublishHtm -Raw
        $updated = $raw -replace '\{VERSION\}', $version.Trim()
        $destPath = "$basePath/publish.htm"
        $updated | Set-Content -Path $destPath
        Write-Host "publish.htm generated at $destPath with version $version"

  - task: PowerShell@2
    condition: succeeded()
    displayName: "Clean appsettings for ${{ parameters.environmentName }}"
    inputs:
      targetType: inline
      script: |
        $target = "${{ parameters.deployRootPath }}\\${{ parameters.environmentFolder }}"
        Write-Host "Removing unwanted appsettings files from $target"
        $remove = @(${{ join(', ', parameters.removeAppSettings) }})
        foreach ($f in $remove) {
          Get-ChildItem -Path $target -Filter $f -Recurse -File -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
        }

  - task: PowerShell@2
    condition: succeeded()
    displayName: "Create zip for ${{ parameters.environmentName }}"
    inputs:
      targetType: inline
      script: |
        $basePath = "${{ parameters.deployRootPath }}\\${{ parameters.environmentFolder }}"
        $zipPath = "$basePath\\{{ parameters.artifactName }}.zip"
        Write-Host "Zipping $basePath to $zipPath"
        if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
        Compress-Archive -Path $basePath\* -DestinationPath $zipPath -Force

  - task: PublishBuildArtifacts@1
    condition: succeeded()
    displayName: "${{ parameters.environmentName }} - Publish Build Artifacts"
    inputs:
      PathtoPublish: "${{ parameters.deployRootPath }}\\${{ parameters.environmentFolder }}\\${{ parameters.artifactName }}.zip"
      artifactName: "${{ parameters.artifactName }}_${{ parameters.environmentFolder }}"
