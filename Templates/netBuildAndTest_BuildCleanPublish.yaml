parameters:
  - name: adoEnvironmentName
    type: string
    values:
      - "Development"
      - "Test"
      - "Production"
  - name: artifactName
    type: string
  - name: rootFolder
    type: string
  - name: buildConfiguration
    type: string
  - name: publishSingleFile
    type: string
    default: "true"
    values:
      - "true"
      - "false"
  # the appsettings files to remove, separated by |
  - name: removeAppSettings
    type: string
    default: ""

steps:
  - task: DotNetCoreCLI@2
    displayName: "Publish ${{ parameters.adoEnvironmentName }}"
    condition: succeeded()
    inputs:
      command: publish
      projects: |
        ${{ parameters.rootFolder }}/**/*.csproj
        !${{ parameters.rootFolder }}/**/*Tests.csproj
      publishWebProjects: false
      publishTestResults: false
      ${{ if eq(parameters.publishSingleFile, 'true') }}:
        arguments: "--configuration ${{ parameters.buildConfiguration }} --output $(Build.ArtifactStagingDirectory)/${{ parameters.adoEnvironmentName }} /p:EnvironmentName=${{ parameters.adoEnvironmentName }} -p:PublishSingleFile=true --self-contained --runtime win-x64 /p:IncludeNativeLibrariesForSelfExtract=true"
      ${{ else }}:
        arguments: "--configuration ${{ parameters.buildConfiguration }} --output $(Build.ArtifactStagingDirectory)/${{ parameters.adoEnvironmentName }} /p:EnvironmentName=${{ parameters.adoEnvironmentName }}"
      zipAfterPublish: false
      modifyOutputPath: false

  - task: PowerShell@2
    displayName: "Remove unwanted appsettings and create ${{ parameters.artifactName }} zip for ${{ parameters.adoEnvironmentName }}"
    condition: succeeded()
    inputs:
      targetType: 'inline'
      script: |
        $src = "$(Build.ArtifactStagingDirectory)/${{ parameters.environmentName }}"
        Write-Host "Cleaning unwanted appsettings ( ${{ parameters.removeAppSettings }} ) from $src"
        $removePattern = '${{ parameters.removeAppSettings }}'
        $remove = @()
        if (![string]::IsNullOrWhiteSpace($removePattern)) {
          $remove = $removePattern.Split('|') | Where-Object { -not [string]::IsNullOrWhiteSpace($_) }
        }
        foreach ($f in $remove) {
          Write-Host "Removing file $f"
          Get-ChildItem -Path $src -Filter $f -Recurse -File -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
        }
        $zipPath = "$(Build.ArtifactStagingDirectory)/${{ parameters.environmentName }}/${{ parameters.artifactName }}.zip"
        Write-Host "Creating zip: $zipPath"
        Compress-Archive -Path "$src\*" -DestinationPath $zipPath -Force

  - task: PublishBuildArtifacts@1
    displayName: "${{ parameters.adoEnvironmentName }} - Publish Build Artifacts"
    condition: succeeded()
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)/${{ parameters.adoEnvironmentName }}/${{ parameters.artifactName }}.zip"
      artifactName: "${{ parameters.artifactName }}_${{ parameters.adoEnvironmentName }}"
